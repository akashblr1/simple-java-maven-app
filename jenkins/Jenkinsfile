pipeline {
    agent any
      environment {
        NEXUS_URL = "http://localhost:8081"
        NEXUS_REPO = "product" // Or your custom hosted repo name, e.g., 'myrepo'
        CREDENTIALS_ID = "nexus-credentials" // Jenkins credential ID
        GROUP_ID = "simple-maven"
        ARTIFACT_ID = "my-application"
        VERSION = "1.0.0"
        FILE_PATH = "target/my-app-1.0-SNAPSHOT.jar" // Path relative to workspace
    }
    options {
        skipStagesAfterUnstable()
    }
    stages {
        stage('Build') {
            steps {
                sh '''
                
                /bin/bash -c  "$HOME/.sdkman/bin/sdkman-init.sh && \
                /var/lib/jenkins/.sdkman/contrib/completion/bash/sdk use java 17.0.17-ms && \
                /var/lib/jenkins/.sdkman/contrib/completion/bash/sdk use maven 3.9.12 && \
                export JAVA_HOME='/var/lib/jenkins/.sdkman/candidates/java/current' && \
                export PATH=\"$JAVA_HOME/bin:$PATH\" && \
                /var/lib/jenkins/.sdkman/candidates/maven/current/bin/mvn --version && \
                /var/lib/jenkins/.sdkman/candidates/maven/current/bin/mvn -B -DskipTests clean package"
                '''
            }
        }
        stage('Test') {
            steps {
            sh '''
                /bin/bash -c  "$HOME/.sdkman/bin/sdkman-init.sh && \
                /var/lib/jenkins/.sdkman/contrib/completion/bash/sdk use maven 3.9.12 && \
                /var/lib/jenkins/.sdkman/candidates/maven/current/bin/mvn test"
                '''
            }
            post {
                always {
                    junit 'target/surefire-reports/*.xml'
                }
            }
        }
        stage('Publish to Nexus') {
            steps {
                script {
                    // Use the readMavenPom step (from Pipeline Utility Steps plugin) 
                    // to dynamically get artifact details if you prefer not to hardcode
                    // def pom = readMavenPom file: 'pom.xml' 
                    
                    // Upload the artifact using the Nexus Artifact Uploader plugin step
                    // The 'nexusVersion: "nexus3"' parameter specifies Nexus 3 compatibility
                    step([
                        $class: 'NexusArtifactUploader',
                        nexusVersion: 'nexus3',
                        protocol: 'http', // or 'https'
                        nexusUrl: NEXUS_URL,
                        groupId: GROUP_ID,
                        version: VERSION,
                        repository: NEXUS_REPO,
                        credentialsId: CREDENTIALS_ID,
                        artifacts: [[
                            artifactId: ARTIFACT_ID,
                            classifier: '',
                            file: FILE_PATH,
                            type: 'jar' // extension of the file
                        ]]
                    ])
                    echo "Successfully uploaded ${FILE_PATH} to Nexus repository: ${NEXUS_REPO}"
                }
            }
        }
    }
}
